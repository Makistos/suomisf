{% extends "base.html" %}
{% block content %}
{% if current_user.is_admin %}
	{% set input_style='class="form-control" onblur=\"saveForm()\"' %}
{% else %}
	{% set input_style='readonly class=form-control-plaintext' %}
{% endif %}
<form method="post">
<div class="container">
	<div class="card border-primary mb-3" style="width: 720px; margin: 1rem auto">
		<div class="card-header">
			<span class="person-list">{{ authors|map(attribute='name')|join(', ') }}</span>
		</div>

		<div class="card-body">
			<h3 class="card-title">
				<input type="text" class="form-control" onblur="saveForm()" id="title" value="{{article.title}}" style="border:0;">
				{% if current_user.is_admin %}
				({{ article.id }})
				{% endif %}
			</h3>
			<a href="{{ url_for('issue', id=article.issue.id)}}">{{ article.issue.magazine.name }}
				{% if article.issue.number -%}
				{{ article.issue.number }} /
				{{ article.issue.year }}
				{%- else -%}
				{{ article.issue.count }}
				{%- endif -%}</a><br>

			<ul class="list-group list-group-flush">
				{% if people|length %}
				<li class="list-group-item">
					<b>Henkilöt:</b>
					{% if current_user.is_admin %}
					<select class="people-selector form-control" multiple="multiple" onchange="saveArticlePeople()">
					</select>
					{% else %}
					<span class="person-list">
						{{ people|map(attribute='name')|join(', ')}}
					</span>
					{% endif %}
				</li>
				{% endif %}
				{% if article.tags %}
				<li class="list-group-item">
					<b>Avainsanat:</b>
					{% for tag in article.tags %}
					<a href="{{url_for('tag', tagid=tag.id)}}">{{tag.name}}<nbsp>
							{% endfor %}
				</li>
				{% endif %}
			</ul>
            {% if current_user.is_admin %}
			<ul class="list-group list-group-flush">
				<li class="list-group-item"><a href="{{url_for('edit_article', id=article.id)}}">Muokkaa</a></li><br>
				<li class="list-group-item">
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editAuthors">Muokkaa kirjoittajia</button>
				</li>
				<li class="list-group-item">
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editPeople">Muokkaa henkilöitä</button>
				</li>
				<li class="list-group-item">
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editLinks">Muokkaa linkkejä</button>
				</li>

			</ul>
			{% endif %}
		</div>

	</div>
</form>
	{% block script %}
	<script src="/static/js/personlink.js" type="text/javascript"></script>
	<script type="text/javascript">
		var articleid = '{{article.id}}'
	</script>
	<script type="text/javascript" class="js-code-placeholder">
	var peopleSelect = $(".people-selector");
	$(document).ready(function() {
		$(".people-selector").select2({
				ajax: {
					url: "/select_person",
					dataType: 'json',
					delay: 250,
					data: function (params) {
						return {
							q: params.term, // search term
						};
					},
				},
				placeholder: 'Artikkeliin liittyvät henkilöt',
				minimumInputLength: 3,
		});
		$.ajax({
			type: 'GET',
			url: '/people_for_article/' + articleid
		}).then(function(data) {
			var people = JSON.parse(data);
			var i;
			for(i = 0; i < people.length; i++) {
				var person = people[i];
				var id = Number(person['id']);
				var name = person['text'];
				var option = new Option(name, id, true, true);
				peopleSelect.append(option).trigger('change');
			}
			$('.people-selector').trigger({
				type: 'select2:select',
				params: {
					data: data
				}
			});
		});
	});
	</script>
	<script type="text/javascript">
		function saveArticlePeople() {
			var people_list = $('.people-selector').select2('data');
			const people = people_list.map((people) => people.id);
			$.ajax({
				url: '/save_article_people/',
				type: "POST",
				dataType: "text json",
				//data: JSON.stringify({people: people, article: articleid}) 
				data: { people: JSON.stringify(people), 
					    article: JSON.stringify(articleid)} 
			})

		}
	</script>
	{% endblock %}
	{% endblock %}