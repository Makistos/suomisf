{% extends "base.html" %}
{% block content %}
{% if current_user.is_admin %}
	{% set input_style='class="form-control" onblur=\"saveForm()\"' %}
{% else %}
	{% set input_style='readonly class=form-control-plaintext' %}
{% endif %}
<form method="post">
<div class="container">
	<div class="card border-primary mb-3" style="width: 720px; margin: 1rem auto">
		<div class="card-header">
			{% if current_user.is_admin %}
			<select class="author-selector form-control" multiple="multiple" onchange="saveSelector('author')">
			</select>
			{% else %}
			<span class="person-list">{{ authors|map(attribute='name')|join(', ') }}</span>
			{% endif %}
		</div>

		<div class="card-body">
			<h3 class="card-title">
				<input type="text" class="form-control" onblur="saveForm()" id="title" value="{{article.title}}" style="border:0;">
				{% if current_user.is_admin %}
				({{ article.id }})
				{% endif %}
			</h3>
			<a href="{{ url_for('issue', id=article.issue.id)}}">{{ article.issue.magazine.name }}
				{% if article.issue.number -%}
				{{ article.issue.number }} /
				{{ article.issue.year }}
				{%- else -%}
				{{ article.issue.count }}
				{%- endif -%}</a><br>

			<ul class="list-group list-group-flush">
				{% if people|length %}
				<li class="list-group-item">
					<b>Henkilöt:</b>
					{% if current_user.is_admin %}
					<select class="people-selector form-control" multiple="multiple" onchange="saveSelector('people')">
					</select>
					{% else %}
					<span class="person-list">
						{{ people|map(attribute='name')|join(', ')}}
					</span>
					{% endif %}
				</li>
				{% endif %}
				{% if article.tags %}
				<li class="list-group-item">
					<b>Avainsanat:</b>
					{% for tag in article.tags %}
					<a href="{{url_for('tag', tagid=tag.id)}}">{{tag.name}}<nbsp>
							{% endfor %}
				</li>
				{% endif %}
			</ul>
            {% if current_user.is_admin %}
			<ul class="list-group list-group-flush">
				<li class="list-group-item"><a href="{{url_for('edit_article', id=article.id)}}">Muokkaa</a></li><br>
				<li class="list-group-item">
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editAuthors">Muokkaa kirjoittajia</button>
				</li>
				<li class="list-group-item">
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editPeople">Muokkaa henkilöitä</button>
				</li>
				<li class="list-group-item">
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editLinks">Muokkaa linkkejä</button>
				</li>

			</ul>
			{% endif %}
		</div>

	</div>
</form>
	{% block script %}
	<script src="/static/js/personlink.js" type="text/javascript"></script>
	<script type="text/javascript">
		var articleid = '{{article.id}}'
	</script>
	<script type="text/javascript">
	var authorSelect = $(".author-selector");
	var peopleSelect = $(".people-selector");
	$(document).ready(function() {
		authorSelect.select2({
			ajax: {
				url: "/select_person",
				dataType: "json",
				delay: 250,
				data: function(params) {
					return {
						q: params.term,
					};
				},
			},
            minimumInputLength: 3
		});

		peopleSelect.select2({
				ajax: {
					url: "/select_person",
					dataType: 'json',
					delay: 250,
					data: function (params) {
						return {
							q: params.term, // search term
						};
					},
				},
				placeholder: 'Artikkeliin liittyvät henkilöt',
				minimumInputLength: 3,
		});

		function fill_options(selector, data) {
			var people = JSON.parse(data);
			for (var i = 0; i < people.length; i++) {
				var person = people[i];
				var id = Number(person['id']);
				var name = person['text'];
				var option = new Option(name, id, true, true);
				selector.append(option).trigger('change');
			}
			selector.trigger({
				type: 'select2:select',
				params: {
					data: data
				}
			});
		}

		/* Fill selectors with data from db. */
		$.ajax({
			type: "GET",
			url: "/authors_for_article/" + articleid
		}).then(data => {
			fill_options(authorSelect, data);
		});
		$.ajax({
			type: 'GET',
			url: '/people_for_article/' + articleid
		}).then(data => {
			fill_options(peopleSelect, data);
		}); 
	});
	</script>
	<script type="text/javascript">
		function saveSelector(target) {
			let item_list = [];
			let endpoint = '';
			if (target === 'people') {
				item_list = peopleSelect.select2('data');
				endpoint = '/save_article_people/'	
			} else if (target == 'authors') {
				item_list = authorSelect.select2('data');
				endpoint = '/save_article_authors/'	
			} else {
				return;
			}
			const items = item_list.map((item) => item.id);
			$.ajax({
				url: endpoint,
				type: "POST",
				dataType: "json",
				data: { items: JSON.stringify(items), 
					    article: JSON.stringify(articleid)} 
			});

		}
	</script>
	<script type="text/javascript">
		function saveArticleForm() {

		}
	</script>
	{% endblock %}
	{% endblock %}