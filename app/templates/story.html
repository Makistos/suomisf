{% extends "base.html" %}
{% block content %}
{% from 'macros.html' import auto_complete %}
{% from 'macros.html' import modal_button %}
<div class="container">
    <div class="card border-primary mb-3" >
        <div class="card-header">
			{% if current_user.is_admin %}
			<a href="#" id="authors" data-type="select2" data-pk="{{story.id}}" data-value="{{authors|map(attribute='id')|join(', ')}}">{{authors|map(attribute='name')|join(', ')}}</a>
			{% else %}
            <span class="person-list">{{ authors|map(attribute='name')|join(', ') }}</span>
            {% endif %}
        </div>

        <div class="card-body">
            <h3 class="card-title">
                {% if current_user.is_admin %}
                <a href="#" id="title" data-type="text" data-pk="{{story.id}}" data-url="/save_story_title" data-title="Nimi">{{story.title}}</a>
                {% else %}
                {{ story.title }}
                {% endif %}
            </h3>
            <div class="col">
                {% if current_user.is_admin %}
                <a href="#" id="orig_title" data-type="text" data-pk="{{story.id}}" data-url="/save_story_orig_title" data-title="Alkup. nimi">{{story.orig_title}}</a>,
                <a href="#" id="pubyear" data-type="text" data-pk="{{story.pubyear}}" data-url="/save_story_pubyear" data-title="Julk.vuosi">{{story.pubyear}}</a>
                {% else %}
                {% if story.title != story.orig_title %}
                {{ story.orig_title }}
                {%- if story.pubyear -%}, {{  story.pubyear }}{% endif %}
                {% endif %}
                {% endif %}
            </div>
            <div class="col container col-lg-4 justify-content-end
			justify-content-center align-middle">
                {% for genre in story.genres %}
                <li class="list-inline-item" style="padding-bottom:
				   1rem;"><img src="/static/icons/{{genre.abbr}}_32.png"></li>
                {% endfor %}
                {% for tag in story.tags %}
                <a href="{{ url_for('tag', tagid=tag.id)}}">{{ tag.name }}</a>
                {% endfor %}
            </div>
        </div>

        {% if works %}
        <dl class="list-group list-group-flush">
            <dt style="margin: 1rem ">Ilmestynyt teoksissa</dt>
            {% for work in works %}
            <dd class="list-group-item">
                {% include "_work.html" %}
                {% for edition in work.editions %}
                {% include "_work_edition.html" %}
                {% endfor %}
            </dd>
            {% endfor %}
        </dl>
        {% endif %}
        {% if story.issues %}
        <dl class="list-group list-group-flush">
            <dt style="margin: 1rem ">Ilmestynyt lehdissä</dt>
            {% for issue in story.issues %}
            <dd class="list-group-item">
                <a href="{{ url_for('issue', id=issue.id)}}">
                    {{ issue.magazine.name }}
                    {% if issue.number %}
                    {{ issue.number }} / {{ issue.year }}
                    {% else %}
                    {{ issue.count }}
                    {% endif %}</a>
            </dd>
            {% endfor %}
        </dl>
        {% endif %}
        {% if current_user.is_admin %}

        <div id="admin" aria-labelledby="headAdmin" data-parent="#workCard">
            <a href="{{url_for('edit_story', id=story.id)}}">Muokkaa</a><br>
            {{ modal_button("editAuthors", "Muokkaa kirjoittajia")}}

        </div>

        <div class="modal fade" id="editAuthors" tabindex="-1" role="dialog" aria-labelledby="editAuthorsLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editAuthorsLabel">Muokkka kirjailijatietoja</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Sulje">
                            <span aria-hidden="true">&times</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            {% for author in authors %}
                            <div class="row">
                                <div class="col-md-8">{{ author.name }}</div>
                                <div class="col-md-4">
                                    <a href="{{ url_for('remove_author_from_story',
                                    storyid=story.id, authorid=author.id)}}">Poista</a><br />
                                </div>
                            </div>
                            {% endfor %}
                            <hr>
                            <form action="" method="post">
                                <div class="form-row">
                                    <div class="col-md-8">
                                        {{ form_author.hidden_tag() }}
                                        {{ form_author.author(id="author") }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form_author.submit }}
                                    </div>
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Sulje</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    </div>
    <script type="text/javascript">
		var storyid = '{{story.id}}'
        $.fn.editable.defaults.mode = 'inline';

        $(document).ready(function() {
            $('#authors').editable( {
                type: 'select2',
                url: '/save_story_authors',
                pk: storyid,
                onblur: 'submit',
                emptytext: 'None',
                viewseparator: ', ',
                id: function(e) {
                    return e[0]['id'];
                },
                select2: {
                    width: '250px',
                    minimumInputLength: 1,
                    ajax: {
                        url: '/select_person',
                        datatype: 'json',
                        delay: 250,
                        //multiple: true,
                        // data: function(params) {
                        //     return {
                        //         query: params.term
                        //     }
                        // },
                        // results: function(data, page) {
                        //     return { results: data}
                        // },
                        tags: false,
                    },
                    initSelection: function (element, callback) {
                        return $.get('/people_for_story', { query: element[0]['text'] }, function(data) {
                            callback(data);
                        }, 'json')
                    },
                    formatResult: function(people) {
                        return people[0]['text'];
                    },
                    formatSelection: function(people) {
                        return people[0]['text'];
                    }
                }
            });
            $('#title').editable();
            $('#orig_title').editable();
            $('#pubyear').editable();
        });

    // $.mockjax({
    //     url: '/select_person',
    //     responseTime: 400,
    //     response: function (settings) {
    //         var res = [];
    //         for (var i = 1; i < 5; i++) {
    //             res.push({
    //                 id: i,
    //                 text: 'cla' + i
    //             });
    //         }
    //         this.responseText = res;
    //     }
    // }); 
    // $.mockjax({
    //     url: '/people_for_story',
    //     responseTime: 100,
    //     responseText: {
    //         EmployeeId: 1,
    //         EmployeeName: 'found by ID'
    //     }
    // }); 
    </script>
    {# {{ auto_complete("author", "/autocomp_person")}} #}
    {% endblock %}